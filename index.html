<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ratio de Série</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:16px; max-width:980px}
    h1{font-size:20px;margin:0 0 10px}
    .muted{color:#666; font-size:13px}
    .card{border:1px solid #ddd; border-radius:14px; padding:12px; margin:12px 0}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input,button,select{font-size:16px; padding:10px; border:1px solid #ccc; border-radius:10px}
    button{cursor:pointer}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #e6e6e6; padding:8px; text-align:center}
    th{background:#f7f7f7; position:sticky; top:0}
    .danger{color:#b00020}
    .ok{color:#0b6b2a}
    label{font-size:13px; color:#333}
    .group{display:flex; flex-direction:column; gap:6px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
    .pill{display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; font-size:13px}
  </style>
</head>

<body>
  <h1>Calcul de séries par rouleaux</h1>
  <div class="muted">
    Stock → Patron (manuel ou auto) → Calcul des séries jusqu’à épuisement.
  </div>

  <div class="two">
    <div class="card">
      <h3 style="margin:0 0 10px">1) Stock (rouleaux)</h3>
      <div class="row">
        <button id="addStock" type="button">+ Ajouter couleur</button>
        <button id="clearAll" type="button" class="danger">Vider tout</button>
      </div>
      <div id="stockWrap" style="margin-top:10px"></div>
      <div class="muted">Les champs sont vides au départ (comme tu veux).</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">2) Patron (manuel + auto)</h3>

      <div class="row" style="margin-bottom:10px">
        <div class="group">
          <label>Couleur base (auto)</label>
          <select id="baseColor" style="min-width:220px"></select>
        </div>

        <div class="group">
          <label>Nombre base (1 / 2)</label>
          <input id="baseFactor" type="number" min="1" step="1" value="1" style="width:140px" />
        </div>

        <div class="group">
          <label>Max par couleur</label>
          <input id="maxPerColor" type="number" min="1" step="1" placeholder="10" style="width:140px" />
        </div>

        <div class="group">
          <label>&nbsp;</label>
          <button id="autoFill" type="button">Auto-remplir patron</button>
        </div>
      </div>

      <div class="row" style="margin-bottom:10px">
        <button id="addPattern" type="button">+ Ajouter case patron</button>
        <button id="copyStockToPattern" type="button">Copier stock → patron</button>
        <button id="clearPattern" type="button">Vider patron</button>
      </div>

      <div class="muted" style="margin:6px 0">
        <span class="pill">Manuel</span> : choisir couleur + quantité.  
        <span class="pill">Auto</span> : calcule selon ratio stock/base (Beige=1 → Noir/Gris/Kaki calculés).
      </div>

      <div id="patternWrap"></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button id="genAll" type="button">Calculer les séries</button>
      <button id="clearResults" type="button">Effacer résultats</button>
    </div>
    <div id="status" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Résultat (Liste)</h3>
    <div id="list"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Résultat (Tableau)</h3>
    <div style="overflow:auto">
      <table id="table"></table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Reste final</h3>
    <div style="overflow:auto">
      <table id="restTable"></table>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // ✅ Champs vides au départ
  const state = {
    stock: [ { name:"", qty:"" } ],   // on garde les lignes vides (pour ne pas “bugger” l’ajout)
    pattern: [],
    series: []
  };

  const trimName = (s)=> (s||"").trim();
  const toInt = (v)=> Math.max(0, Math.floor(Number(v)||0));

  function cleanedStock(){
    return state.stock
      .map(x=>({name: trimName(x.name), qty: toInt(x.qty)}))
      .filter(x=>x.name.length>0);
  }

  function cleanedPattern(){
    return state.pattern
      .map(x=>({name: trimName(x.name), qty: toInt(x.qty)}))
      .filter(x=>x.name.length>0 && x.qty>=0);
  }

  function setStatus(msg, danger){
    $("status").innerHTML = `<span class="${danger ? "danger" : "ok"}">${msg}</span>`;
  }

  function stockNames(){
    return cleanedStock().map(s=>s.name);
  }

  function renderBaseSelector(){
    const sel = $("baseColor");
    const keep = sel.value || "";
    sel.innerHTML = "";

    const names = stockNames();
    if(names.length===0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Ajoute une couleur…";
      sel.appendChild(opt);
      return;
    }

    names.forEach(n=>{
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });

    sel.value = names.includes(keep) ? keep : names[0];
  }

  function renderStock(){
    const wrap = $("stockWrap");
    wrap.innerHTML = "";

    state.stock.forEach((c,i)=>{
      const row = document.createElement("div");
      row.className = "row";
      row.style.margin = "8px 0";

      const name = document.createElement("input");
      name.value = c.name || "";
      name.placeholder = "Couleur";
      name.style.width = "220px";
      name.oninput = ()=>{ state.stock[i].name = name.value; };

      const qty = document.createElement("input");
      qty.type="number"; qty.min="0"; qty.step="1";
      qty.value = (c.qty === "" || c.qty === null || c.qty === undefined) ? "" : c.qty;
      qty.placeholder="Rouleaux";
      qty.style.width="160px";
      qty.oninput = ()=>{ state.stock[i].qty = qty.value; };

      const del = document.createElement("button");
      del.type="button";
      del.textContent="Supprimer";
      del.className="danger";
      del.onclick = ()=>{
        state.stock.splice(i,1);
        if(state.stock.length===0) state.stock.push({name:"", qty:""});
        renderAll();
      };

      row.appendChild(name);
      row.appendChild(qty);
      row.appendChild(del);
      wrap.appendChild(row);
    });
  }

  function renderPattern(){
    const wrap = $("patternWrap");
    wrap.innerHTML = "";

    const names = stockNames();

    if(state.pattern.length===0){
      wrap.innerHTML = `<div class="muted">Patron vide. Clique “Copier stock → patron” ou “+ Ajouter case patron”.</div>`;
      return;
    }

    state.pattern.forEach((p,i)=>{
      const row = document.createElement("div");
      row.className = "row";
      row.style.margin = "8px 0";

      const sel = document.createElement("select");
      sel.style.width = "220px";

      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "Choisir couleur…";
      sel.appendChild(optEmpty);

      names.forEach(n=>{
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });

      sel.value = names.includes(p.name) ? p.name : "";
      sel.onchange = ()=>{ state.pattern[i].name = sel.value; };

      const qty = document.createElement("input");
      qty.type="number"; qty.min="0"; qty.step="1";
      qty.value = (p.qty === "" || p.qty === null || p.qty === undefined) ? "" : p.qty;
      qty.placeholder="Par série";
      qty.style.width="160px";
      qty.oninput = ()=>{ state.pattern[i].qty = qty.value; };

      const del = document.createElement("button");
      del.type="button";
      del.textContent="Supprimer";
      del.className="danger";
      del.onclick = ()=>{
        state.pattern.splice(i,1);
        renderAll();
      };

      row.appendChild(sel);
      row.appendChild(qty);
      row.appendChild(del);
      wrap.appendChild(row);
    });
  }

  function totalObj(obj){
    return Object.values(obj).reduce((a,b)=>a+(Number(b)||0),0);
  }

  function totalPattern(){
    return cleanedPattern().reduce((a,x)=>a + (x.qty||0), 0);
  }

  function copyStockToPattern(){
    const st = cleanedStock();
    if(st.length===0){
      setStatus("Ajoute d’abord des couleurs dans le stock.", true);
      return;
    }
    state.pattern = st.map(s=>({name:s.name, qty:""})); // ✅ vide, pas 0
    renderAll();
    setStatus("Patron créé (lignes vides) ✅", false);
  }

  // ✅ Auto ratio correct (et maxPerColor par défaut si vide)
  function autoFillPattern(){
    const st = cleanedStock();
    if(st.length===0){
      setStatus("Ajoute au moins une couleur avec un stock.", true);
      return;
    }

    const baseColor = $("baseColor").value;
    const base = Math.max(1, Math.floor(Number($("baseFactor").value)||1));

    const rawMax = $("maxPerColor").value;
    let maxPer = Math.floor(Number(rawMax));
    if(!Number.isFinite(maxPer) || maxPer < 1) maxPer = 10; // ✅ si champ vide → 10

    const baseObj = st.find(s=>s.name===baseColor);
    const baseStock = baseObj ? baseObj.qty : 0;
    if(baseStock <= 0){
      setStatus("La couleur base doit avoir un stock > 0.", true);
      return;
    }

    const pat = st.map(s=>{
      let q;
      if(s.name === baseColor){
        q = base;
      } else {
        q = Math.round((s.qty / baseStock) * base);
      }
      q = Math.min(q, maxPer);
      q = Math.min(q, s.qty);
      return {name:s.name, qty:String(q)};
    });

    // base en premier
    pat.sort((a,b)=>{
      if(a.name===baseColor) return -1;
      if(b.name===baseColor) return 1;
      return a.name.localeCompare(b.name);
    });

    state.pattern = pat;
    renderAll();
    setStatus(`Patron auto rempli ✅ (base ${baseColor}=${base}, max=${maxPer})`, false);
  }

  function computeSeries(){
    const st = cleanedStock();
    const patArr = cleanedPattern();
    state.series = [];

    if(st.length===0){
      renderAll();
      setStatus("Stock vide.", true);
      return;
    }
    if(patArr.length===0 || totalPattern()<=0){
      renderAll();
      setStatus("Patron vide (ou tout à 0).", true);
      return;
    }

    const rem = {};
    st.forEach(s=> rem[s.name] = s.qty);

    const pat = {};
    patArr.forEach(p=>{ pat[p.name] = toInt(p.qty); });

    for(let guard=0; guard<20000; guard++){
      if(totalObj(rem)===0) break;

      const alloc = {};
      let tookAny = false;

      for(const [color, need0] of Object.entries(pat)){
        const need = toInt(need0);
        if(need===0) continue;
        const avail = rem[color] ?? 0;
        const take = Math.min(avail, need);
        alloc[color] = take;
        rem[color] = avail - take;
        if(take>0) tookAny = true;
      }

      if(!tookAny){
        const last = {};
        for(const [c,q] of Object.entries(rem)){
          if(q>0){ last[c]=q; rem[c]=0; }
        }
        state.series.push({index: state.series.length+1, allocations:last});
        break;
      }

      state.series.push({index: state.series.length+1, allocations:alloc});
    }

    renderAll();
    setStatus(`Séries calculées ✅ (${state.series.length})`, false);
  }

  function allColorsUnion(){
    const set = new Set();
    cleanedStock().forEach(s=>set.add(s.name));
    cleanedPattern().forEach(p=>set.add(p.name));
    state.series.forEach(sr=>Object.keys(sr.allocations||{}).forEach(k=>set.add(k)));
    return Array.from(set);
  }

  function renderList(){
    const el = $("list");
    if(state.series.length===0){
      el.innerHTML = `<div class="muted">Aucune série.</div>`;
      return;
    }
    el.innerHTML = state.series.map(sr=>{
      const parts = Object.entries(sr.allocations)
        .filter(([_,v])=> (Number(v)||0) > 0)
        .map(([k,v])=> `${k}: ${v}`)
        .join(" • ");
      return `<div style="margin:6px 0"><b>Série ${sr.index}</b> — ${parts || "<span class='muted'>vide</span>"}</div>`;
    }).join("");
  }

  function renderTable(){
    const t = $("table");
    if(state.series.length===0){
      t.innerHTML = `<tr><td class="muted">Aucune donnée.</td></tr>`;
      return;
    }
    const cols = allColorsUnion();
    let html = "<tr><th>Série</th>";
    cols.forEach(c=> html += `<th>${c}</th>`);
    html += "</tr>";

    state.series.forEach(sr=>{
      html += `<tr><td><b>${sr.index}</b></td>`;
      cols.forEach(c=>{
        html += `<td>${sr.allocations?.[c] ?? 0}</td>`;
      });
      html += "</tr>";
    });
    t.innerHTML = html;
  }

  function renderReste(){
    const st = cleanedStock();
    const rem = {};
    st.forEach(s=> rem[s.name] = s.qty);

    state.series.forEach(sr=>{
      for(const [c,v] of Object.entries(sr.allocations||{})){
        rem[c] = Math.max(0, (rem[c]??0) - (Number(v)||0));
      }
    });

    const cols = allColorsUnion();
    const t = $("restTable");
    let html = "<tr>";
    cols.forEach(c=> html += `<th>${c}</th>`);
    html += "<th>Total</th></tr><tr>";
    cols.forEach(c=> html += `<td>${rem[c] ?? 0}</td>`);
    html += `<td><b>${totalObj(rem)}</b></td></tr>`;
    t.innerHTML = html;
  }

  function renderAll(){
    renderBaseSelector();
    renderStock();
    renderPattern();
    renderList();
    renderTable();
    renderReste();
  }

  // Buttons
  $("addStock").addEventListener("click", ()=>{
    state.stock.push({name:"", qty:""});
    renderAll();
  });

  $("clearAll").addEventListener("click", ()=>{
    state.stock = [{name:"", qty:""}];
    state.pattern = [];
    state.series = [];
    renderAll();
    setStatus("Tout vidé ✅", false);
  });

  $("addPattern").addEventListener("click", ()=>{
    state.pattern.push({name:"", qty:""});
    renderAll();
  });

  $("copyStockToPattern").addEventListener("click", ()=> copyStockToPattern());

  $("clearPattern").addEventListener("click", ()=>{
    state.pattern = [];
    renderAll();
    setStatus("Patron vidé ✅", false);
  });

  $("autoFill").addEventListener("click", ()=> autoFillPattern());

  $("genAll").addEventListener("click", ()=> computeSeries());

  $("clearResults").addEventListener("click", ()=>{
    state.series = [];
    renderAll();
    setStatus("Résultats effacés ✅", false);
  });

  renderAll();
</script>
</body>
</html>
