<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ration Série</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:16px; max-width:900px}
    h1{font-size:20px;margin:0 0 12px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input,button{font-size:16px; padding:10px; border:1px solid #ccc; border-radius:10px}
    button{cursor:pointer}
    .card{border:1px solid #ddd; border-radius:14px; padding:12px; margin:12px 0}
    table{border-collapse:collapse; width:100%; overflow:auto}
    th,td{border:1px solid #e3e3e3; padding:8px; text-align:center}
    th{position:sticky; top:0; background:#f8f8f8}
    .muted{color:#666; font-size:13px}
    .danger{color:#b00020}
    .ok{color:#0b6b2a}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <h1>Ration Série</h1>
  <div class="muted">Base et couleurs 100% variables • uniquement entiers • liste + tableau • reste visible</div>

  <div class="card">
    <div class="row">
      <label class="nowrap">Base (taille série)</label>
      <input id="base" type="number" min="1" step="1" value="20" style="width:140px" />
      <button id="addColor">+ Ajouter couleur</button>
      <button id="save">Enregistrer</button>
      <button id="reset" class="danger">Reset</button>
    </div>
    <div id="colors" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="row">
      <button id="genOne">Générer 1 série</button>
      <button id="genAll">Générer toutes les séries</button>
      <button id="clearSeries">Effacer les séries</button>
    </div>
    <div class="muted" style="margin-top:8px">
      Règle: on remplit une série en prenant d’abord les couleurs avec le plus de stock restant (greedy), sans décimales.
    </div>
    <div id="status" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Résultat (Liste)</h3>
    <div id="list"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Résultat (Tableau)</h3>
    <div style="overflow:auto">
      <table id="table"></table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Reste (stock restant après séries)</h3>
    <div style="overflow:auto">
      <table id="restTable"></table>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const state = {
    base: 20,
    colors: [
      { name: "Noir", qty: 40 },
      { name: "Gris", qty: 30 },
      { name: "Kaki", qty: 15 },
      { name: "Beige", qty: 10 }
    ],
    series: [] // each series: {index, allocations: {colorName: usedQty}, base}
  };

  function load(){
    const raw = localStorage.getItem("ration_serie_v2");
    if(raw){
      try{
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed === "object"){
          state.base = parsed.base ?? state.base;
          state.colors = Array.isArray(parsed.colors) ? parsed.colors : state.colors;
          state.series = Array.isArray(parsed.series) ? parsed.series : [];
        }
      }catch(e){}
    }
  }

  function save(){
    localStorage.setItem("ration_serie_v2", JSON.stringify({
      base: state.base,
      colors: state.colors,
      series: state.series
    }));
  }

  function normalizeColors(){
    // remove empty names, clamp quantities to integers >=0
    state.colors = state.colors
      .map(c=>({
        name: (c.name ?? "").trim(),
        qty: Math.max(0, Math.floor(Number(c.qty)||0))
      }))
      .filter(c=>c.name.length>0);
  }

  function renderColors(){
    $("base").value = state.base;
    const wrap = $("colors");
    wrap.innerHTML = "";

    state.colors.forEach((c, i)=>{
      const row = document.createElement("div");
      row.className = "row";
      row.style.margin = "8px 0";

      const name = document.createElement("input");
      name.value = c.name;
      name.placeholder = "Couleur";
      name.style.width = "220px";
      name.oninput = ()=>{ state.colors[i].name = name.value; };

      const qty = document.createElement("input");
      qty.type = "number";
      qty.min = "0";
      qty.step = "1";
      qty.value = c.qty;
      qty.placeholder = "Quantité";
      qty.style.width = "160px";
      qty.oninput = ()=>{ state.colors[i].qty = qty.value; };

      const del = document.createElement("button");
      del.textContent = "Supprimer";
      del.className = "danger";
      del.onclick = ()=>{
        state.colors.splice(i,1);
        normalizeColors(); save(); renderAll();
      };

      row.appendChild(name);
      row.appendChild(qty);
      row.appendChild(del);
      wrap.appendChild(row);
    });
  }

  function remainingStock(){
    // start from initial colors, subtract all series allocations
    const rem = {};
    state.colors.forEach(c=> rem[c.name] = Math.max(0, Math.floor(Number(c.qty)||0)));

    state.series.forEach(s=>{
      for(const [k,v] of Object.entries(s.allocations)){
        if(rem[k] == null) rem[k] = 0; // in case color list changed
        rem[k] = Math.max(0, rem[k] - v);
      }
    });
    return rem;
  }

  function sumRem(rem){
    return Object.values(rem).reduce((a,b)=>a+b,0);
  }

  function genOneSeries(){
    state.base = Math.max(1, Math.floor(Number($("base").value)||1));
    normalizeColors();

    const base = state.base;
    const rem = remainingStock();

    // Only use colors that exist in current list; if list changed, we still keep rem for old series columns later
    const candidates = Object.entries(rem)
      .filter(([name,qty]) => qty>0)
      .sort((a,b)=> b[1]-a[1]); // highest remaining first

    if(sumRem(rem) < base){
      setStatus("Impossible de faire une série complète: stock restant total < base.", true);
      return false;
    }

    let need = base;
    const alloc = {};
    for(const [name,qty] of candidates){
      if(need<=0) break;
      const take = Math.min(qty, need);
      if(take>0){
        alloc[name] = take;
        need -= take;
      }
    }

    if(need !== 0){
      // theoretically shouldn't happen if sumRem>=base
      setStatus("Erreur: la série n’a pas pu être remplie complètement.", true);
      return false;
    }

    state.series.push({
      index: state.series.length + 1,
      base,
      allocations: alloc
    });

    save();
    renderAll();
    setStatus("Série ajoutée ✅", false);
    return true;
  }

  function genAllSeries(){
    let made = 0;
    // safety cap to avoid infinite loops if something weird happens
    for(let i=0;i<5000;i++){
      const ok = genOneSeries();
      if(!ok) break;
      made++;
    }
    if(made===0){
      // status already set
      return;
    }
    setStatus(`${made} série(s) générée(s) ✅`, false);
  }

  function setStatus(msg, danger){
    $("status").innerHTML = `<span class="${danger ? "danger" : "ok"}">${msg}</span>`;
  }

  function renderList(){
    const list = $("list");
    if(state.series.length===0){
      list.innerHTML = `<div class="muted">Aucune série pour le moment.</div>`;
      return;
    }

    const lines = state.series.map(s=>{
      const parts = Object.entries(s.allocations).map(([k,v])=>`${k}: ${v}`).join(" • ");
      return `<div style="margin:6px 0"><b>Série ${s.index}</b> (Base ${s.base}) — ${parts}</div>`;
    });
    list.innerHTML = lines.join("");
  }

  function allColorNamesForTable(){
    // union of current colors + colors seen in series
    const set = new Set();
    state.colors.forEach(c=> set.add(c.name));
    state.series.forEach(s=>{
      Object.keys(s.allocations).forEach(k=> set.add(k));
    });
    return Array.from(set);
  }

  function renderTable(){
    const table = $("table");
    const cols = allColorNamesForTable();
    if(state.series.length===0){
      table.innerHTML = `<tr><td class="muted">Aucune donnée.</td></tr>`;
      return;
    }

    let html = "<tr><th>Série</th><th>Base</th>";
    cols.forEach(c=> html += `<th>${c}</th>`);
    html += "</tr>";

    state.series.forEach(s=>{
      html += `<tr><td><b>${s.index}</b></td><td>${s.base}</td>`;
      cols.forEach(c=>{
        const v = s.allocations[c] ?? 0;
        html += `<td>${v}</td>`;
      });
      html += "</tr>";
    });

    table.innerHTML = html;
  }

  function renderReste(){
    const rest = $("restTable");
    const rem = remainingStock();
    const cols = allColorNamesForTable();
    let html = "<tr>";
    cols.forEach(c=> html += `<th>${c}</th>`);
    html += "<th>Total restant</th></tr><tr>";
    cols.forEach(c=> html += `<td>${rem[c] ?? 0}</td>`);
    html += `<td><b>${sumRem(rem)}</b></td></tr>`;
    rest.innerHTML = html;
  }

  function renderAll(){
    renderColors();
    renderList();
    renderTable();
    renderReste();
  }

  // UI handlers
  $("addColor").onclick = ()=>{
    state.colors.push({name:"", qty:0});
    renderColors();
  };

  $("save").onclick = ()=>{
    state.base = Math.max(1, Math.floor(Number($("base").value)||1));
    normalizeColors(); save(); renderAll();
    setStatus("Enregistré ✅", false);
  };

  $("reset").onclick = ()=>{
    localStorage.removeItem("ration_serie_v2");
    location.reload();
  };

  $("genOne").onclick = ()=> genOneSeries();
  $("genAll").onclick = ()=> genAllSeries();

  $("clearSeries").onclick = ()=>{
    state.series = [];
    save(); renderAll();
    setStatus("Séries effacées ✅", false);
  };

  // init
  load();
  state.base = Math.max(1, Math.floor(Number(state.base)||1));
  normalizeColors();
  renderAll();
</script>
</body>
</html>
